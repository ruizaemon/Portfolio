---
import { getCollection, render } from 'astro:content';
import { languages } from '@/utils/languages';
import MarkdownPostLayout from '@/layouts/MarkdownPostLayout.astro';
import { calculateReadingTime } from '@/utils/readingTime';
import { readFileSync } from 'node:fs';
import { join } from 'node:path';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const paths: Array<{ params: { lang: string; slug: string }; props: { post: any } }> = [];
  
  languages.forEach((lang) => {
    posts
      .filter((post) => post.data.lang === lang.code)
      .forEach((post) => {
        // Extract just the filename from the full id (e.g., "en/hello-world" -> "hello-world")
        const filename = post.id.split('/').pop() as string;
        paths.push({
          params: { lang: lang.code, slug: filename },
          props: { post },
        });
      });
  });
  
  return paths;
}

const { post } = Astro.props;
const { Content } = await render(post);

// Calculate reading time from raw markdown content
const markdownPath = join(process.cwd(), 'src', 'content', 'blog', `${post.id}.md`);
const rawContent = readFileSync(markdownPath, 'utf-8');
const readingTime = calculateReadingTime(rawContent, post.data.lang);
---

<MarkdownPostLayout frontmatter={post.data} readingTime={readingTime}>
  <Content />
</MarkdownPostLayout>

